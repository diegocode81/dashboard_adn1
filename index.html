<!-- index.html (solo el formulario con el JS) -->
<form id="f">
  <input type="file" id="file" name="file" accept=".csv" required />
  <button type="submit" id="btn">Subir y cargar</button>
</form>

<pre id="out"></pre>

<script>
  const f = document.getElementById('f');
  const out = document.getElementById('out');
  const btn = document.getElementById('btn');

  f.addEventListener('submit', async (e) => {
    e.preventDefault();
    out.textContent = '';
    btn.disabled = true;

    try {
      const fd = new FormData(f);             // NO pongas Content-Type manual; el navegador añade el boundary
      const resp = await fetch('/api/upload', { method: 'POST', body: fd });

      const ct = resp.headers.get('content-type') || '';
      if (!ct.includes('application/json')) {
        const text = await resp.text();
        out.textContent = `Error: la API no devolvió JSON.\n\nStatus: ${resp.status}\n\nRespuesta:\n${text}`;
        return;
      }
      const data = await resp.json();
      out.textContent = JSON.stringify(data, null, 2);
    } catch (err) {
      out.textContent = `Error de red/JS: ${err?.message || err}`;
    } finally {
      btn.disabled = false;
    }
  });
</script>
